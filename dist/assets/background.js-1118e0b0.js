chrome.runtime.onInstalled.addListener(()=>{console.log("User Interaction Recorder extension installed"),chrome.storage.local.set({folderStructure:{Reports:{}}})});let r=null,o=null;chrome.runtime.onMessage.addListener((e,c,n)=>{if(e.action==="startRecording")chrome.tabs.query({active:!0,currentWindow:!0},t=>{r=t[0].id,o={interactions:[],screenshots:[]},chrome.tabs.sendMessage(r,{action:"startRecording"})});else if(e.action==="stopRecording")r&&chrome.tabs.sendMessage(r,{action:"stopRecording"});else if(e.action==="newInteraction")o&&(o.interactions.push(e.interaction),u());else if(e.action==="recordingComplete")console.log("Recording complete:",o),f(o),o=null;else if(e.action==="getRecordings"){const{page:t,itemsPerPage:i}=e;return chrome.storage.local.get(["recordings"],a=>{const d=a.recordings||[],s=(t-1)*i,l=s+i,g=d.slice(s,l);n({recordings:g})}),!0}else e.action==="updateRecording"&&h(e.recording)});function u(){r&&chrome.tabs.captureVisibleTab(null,{format:"png"},e=>{o&&o.screenshots.push(e)})}function f(e){chrome.storage.local.get(["recordings"],c=>{const n=c.recordings||[];n.unshift({id:Date.now(),timestamp:new Date().toISOString(),...e}),chrome.storage.local.set({recordings:n})})}function h(e){chrome.storage.local.get(["recordings"],c=>{const n=c.recordings||[],t=n.findIndex(i=>i.id===e.id);t!==-1&&(n[t]=e,chrome.storage.local.set({recordings:n}))})}
